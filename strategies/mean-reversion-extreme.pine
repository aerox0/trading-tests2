//@version=6
strategy("Mean Reversion at Extremes", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=10, commission_type=strategy.commission.percent, commission_value=0.1)

// ===== INPUTS =====
len_ma = input.int(20, "MA Length", minval=5, maxval=50)
len_std = input.int(20, "Std Dev Length", minval=5, maxval=50)
mult = input.float(2.5, "Band Multiplier", minval=1.5, maxval=4.0, step=0.1)
atr_mult = input.float(0.5, "ATR Stop Loss Multiplier", minval=0.2, maxval=1.0, step=0.1)
atr_len = input.int(14, "ATR Length", minval=5, maxval=50)
use_sma = input.bool(false, "Use SMA instead of EMA")

// ===== CALCULATIONS =====
// Moving Average
ma = use_sma ? ta.sma(close, len_ma) : ta.ema(close, len_ma)

// Standard Deviation
std = ta.stdev(close, len_std)

// Bollinger Bands (2.5 std dev for fat tails)
upper_band = ma + (mult * std)
lower_band = ma - (mult * std)

// ATR for stop loss
atr = ta.atr(atr_len)

// ===== SIGNALS =====
// Long Entry: Price closes below lower band
long_condition = close < lower_band

// Short Entry: Price closes above upper band
short_condition = close > upper_band

// Target: Return to mean (MA)
long_target_price = ma
short_target_price = ma

// Stop Loss: Band + 0.5 ATR
long_sl = lower_band - (atr_mult * atr)
short_sl = upper_band + (atr_mult * atr)

// ===== PLOTS =====
plot(ma, "Moving Average", color=color.new(color.blue, 0), linewidth=2)
plot(upper_band, "Upper Band (Mean Reversion)", color=color.new(color.red, 0), linewidth=1)
plot(lower_band, "Lower Band (Mean Reversion)", color=color.new(color.green, 0), linewidth=1)

// Fill between bands
fill(plot(upper_band), plot(lower_band), color=color.new(color.gray, 85))

// ===== STRATEGY =====
// Entry
if long_condition and strategy.position_size == 0
    strategy.entry("Long", strategy.long)

if short_condition and strategy.position_size == 0
    strategy.entry("Short", strategy.short)

// Exit Conditions
if strategy.position_size > 0
    // Long position exit
    strategy.exit("Long Exit", "Long", limit=long_target_price, stop=long_sl)
    // Also exit if price crosses above MA
    if close > ma
        strategy.close("Long", comment="Crossed MA")

if strategy.position_size < 0
    // Short position exit
    strategy.exit("Short Exit", "Short", limit=short_target_price, stop=short_sl)
    // Also exit if price crosses below MA
    if close < ma
        strategy.close("Short", comment="Crossed MA")

// ===== ALERTS =====
alertcondition(long_condition, title="Long Entry Signal", message="Mean Reversion: Long signal at {{close}}")
alertcondition(short_condition, title="Short Entry Signal", message="Mean Reversion: Short signal at {{close}}")

// ===== VISUAL MARKERS =====
plotshape(long_condition, "Long Signal", shape.triangleup, location.belowbar, color.new(color.green, 0), size=size.small)
plotshape(short_condition, "Short Signal", shape.triangledown, location.abovebar, color.new(color.red, 0), size=size.small)

// ===== INFO TABLE =====
var table info_table = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    table.cell(info_table, 0, 0, "MA Value", text_color=color.white, text_size=size.small)
    table.cell(info_table, 1, 0, str.tostring(ma, "#.##"), text_color=color.yellow, text_size=size.small)
    table.cell(info_table, 0, 1, "Upper Band", text_color=color.white, text_size=size.small)
    table.cell(info_table, 1, 1, str.tostring(upper_band, "#.##"), text_color=color.red, text_size=size.small)
    table.cell(info_table, 0, 2, "Lower Band", text_color=color.white, text_size=size.small)
    table.cell(info_table, 1, 2, str.tostring(lower_band, "#.##"), text_color=color.green, text_size=size.small)
    table.cell(info_table, 0, 3, "Current Price", text_color=color.white, text_size=size.small)
    table.cell(info_table, 1, 3, str.tostring(close, "#.##"), text_color=color.white, text_size=size.small)
    table.cell(info_table, 0, 4, "ATR", text_color=color.white, text_size=size.small)
    table.cell(info_table, 1, 4, str.tostring(atr, "#.##"), text_color=color.orange, text_size=size.small)
    table.cell(info_table, 0, 5, "Position", text_color=color.white, text_size=size.small)
    pos_text = strategy.position_size > 0 ? "LONG" : strategy.position_size < 0 ? "SHORT" : "NONE"
    pos_color = strategy.position_size > 0 ? color.green : strategy.position_size < 0 ? color.red : color.gray
    table.cell(info_table, 1, 5, pos_text, text_color=pos_color, text_size=size.small)
