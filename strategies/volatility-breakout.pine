//@version=6
strategy("Volatility Breakout - Donchian Channel", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// Inputs
length = input.int(20, "Donchian Channel Length", minval=1, maxval=100)
useVolumeFilter = input.bool(false, "Use Volume Confirmation")
volumeMult = input.float(1.1, "Volume Multiplier for Confirmation", minval=1.0, maxval=3.0, step=0.1)
riskReward = input.float(2.0, "Risk/Reward Ratio", minval=1.0, maxval=5.0, step=0.1)
useSessionFilter = input.bool(false, "Use Time-of-Day Filter")
startHour = input.int(17, "Start Hour (UTC)", minval=0, maxval=23)
endHour = input.int(22, "End Hour (UTC)", minval=0, maxval=23)

// Donchian Channel Calculation
upperDonchian = ta.highest(high, length)
lowerDonchian = ta.lowest(low, length)
midDonchian = math.avg(upperDonchian, lowerDonchian)

// Volume Analysis
smaVolume = ta.sma(volume, 20)
volumeConfirmed = volume > (smaVolume * volumeMult)

// Time-based Filter (optional)
sessionFilter = useSessionFilter ? (hour >= startHour and hour <= endHour) : true

// Entry Conditions
// Use previous bar's Donchian levels for breakout detection
longCondition = ta.crossover(close, upperDonchian[1]) and (not useVolumeFilter or volumeConfirmed) and sessionFilter
shortCondition = ta.crossunder(close, lowerDonchian[1]) and (not useVolumeFilter or volumeConfirmed) and sessionFilter

// Risk Management
var float longStopLoss = na
var float longTakeProfit = na
var float shortStopLoss = na
var float shortTakeProfit = na

// Calculate Stop Loss and Take Profit
longStopLoss := lowerDonchian
longTakeProfit := close + ((close - lowerDonchian) * riskReward)

shortStopLoss := upperDonchian
shortTakeProfit := close - ((upperDonchian - close) * riskReward)

// Trade Execution
if longCondition and strategy.position_size == 0
    strategy.entry("Long", strategy.long)
    strategy.exit("Exit Long", "Long", stop=longStopLoss, limit=longTakeProfit)

if shortCondition and strategy.position_size == 0
    strategy.entry("Short", strategy.short)
    strategy.exit("Exit Short", "Short", stop=shortStopLoss, limit=shortTakeProfit)

// Plotting
plot(upperDonchian, "Upper Donchian", color=color.new(color.green, 0))
plot(lowerDonchian, "Lower Donchian", color=color.new(color.red, 0))
plot(midDonchian, "Mid Donchian", color=color.new(color.blue, 50), linewidth=1)

// Highlight breakouts
bgcolor(longCondition ? color.new(color.green, 90) : shortCondition ? color.new(color.red, 90) : na)

// Entry markers
plotshape(longCondition, title="Long Entry", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small)
plotshape(shortCondition, title="Short Entry", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small)

// Stop Loss and Take Profit visualization (when in position)
plot(strategy.position_size > 0 ? longStopLoss : na, "Long SL", color=color.red, style=plot.style_linebr)
plot(strategy.position_size > 0 ? longTakeProfit : na, "Long TP", color=color.green, style=plot.style_linebr)
plot(strategy.position_size < 0 ? shortStopLoss : na, "Short SL", color=color.red, style=plot.style_linebr)
plot(strategy.position_size < 0 ? shortTakeProfit : na, "Short TP", color=color.green, style=plot.style_linebr)
